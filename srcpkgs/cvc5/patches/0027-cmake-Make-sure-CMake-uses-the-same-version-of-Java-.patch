From 56f220b290317644ffa1e53eda8c5def61b8f0ac Mon Sep 17 00:00:00 2001
From: Daniel Larraz <daniel-larraz@users.noreply.github.com>
Date: Fri, 16 Aug 2024 19:27:21 +0200
Subject: [PATCH 027/312] cmake: Make sure CMake uses the same version of Java
 and JNI (#11163)

---
 src/api/java/CMakeLists.txt | 24 ++++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/src/api/java/CMakeLists.txt b/src/api/java/CMakeLists.txt
index 474a263a2..34fe18108 100644
--- a/src/api/java/CMakeLists.txt
+++ b/src/api/java/CMakeLists.txt
@@ -184,12 +184,32 @@ add_custom_command(
 add_custom_target(generate-jni-headers DEPENDS ${JNI_HEADERS})
 add_dependencies(generate-jni-headers generate-java-kinds generate-java-types generate-java-proofrules generate-java-skolemfunids)
 
+if(NOT DEFINED JAVA_HOME AND NOT WIN32)
+  # If there are multiple versions of Java on the system,
+  # CMake might find a version of JNI that differs from
+  # the version of the Java executable. To address this,
+  # we retrieve the java.home from the JVM settings and
+  # set the JAVA_HOME variable.
+  # This approach works properly on Unix systems but
+  # not on Windows.
+  execute_process(
+    COMMAND ${Java_JAVA_EXECUTABLE} -XshowSettings:runtime -version
+    OUTPUT_VARIABLE java_settings
+    ERROR_VARIABLE java_settings
+    OUTPUT_STRIP_TRAILING_WHITESPACE
+  )
+  # Extract the line containing "java.home"
+  string(REGEX MATCH "java.home = [^\r\n]+" java_home_line "${java_settings}")
+  # Extract the path from the line
+  string(REPLACE "java.home = " "" JAVA_HOME "${java_home_line}")
+  message(STATUS "JAVA_HOME: ${JAVA_HOME}")
+endif()
+
 # find jni package
 find_package(JNI REQUIRED)
-message(STATUS "JAVA_AWT_LIBRARY     : ${JAVA_AWT_LIBRARY}")
+message(STATUS "JNI_FOUND            : ${JNI_FOUND}")
 message(STATUS "JNI_INCLUDE_DIRS     : ${JNI_INCLUDE_DIRS}")
 message(STATUS "JNI_LIBRARIES        : ${JNI_LIBRARIES} ")
-message(STATUS "JNI_FOUND            : ${JNI_FOUND}")
 message(STATUS "JAVA_AWT_LIBRARY     : ${JAVA_AWT_LIBRARY}")
 message(STATUS "JAVA_JVM_LIBRARY     : ${JAVA_JVM_LIBRARY}")
 message(STATUS "JAVA_INCLUDE_PATH    : ${JAVA_INCLUDE_PATH}")
-- 
2.47.1

